rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public read for departments and courses (authenticated users only)
    match /departments/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    match /courses/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // User profile rules with Super Admin support
    match /users/{userId} {
      // Users can create their own profile during registration
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Any authenticated user can read any user profile
      allow read: if request.auth != null;
      
      // Users can update their own profile but cannot change role to super_admin
      allow update: if request.auth != null && request.auth.uid == userId &&
        (request.resource.data.role == resource.data.role ||
         request.resource.data.role == 'alumni' ||
         request.resource.data.role == 'dept_head');
      
      // Alumni association admin can update digitalIdStatus fields
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['alumni_association_admin', 'super_admin'] &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['digitalIdStatus', 'digitalIdApprovedAt', 'digitalIdRejectedAt', 'updatedAt']);
      
      // Only super admin can modify other users' roles (only to alumni or dept_head)
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' &&
        (request.resource.data.role == 'alumni' || request.resource.data.role == 'dept_head');
      
      // Only super admin can delete users
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Posts rules with Super Admin support
    match /posts/{postId} {
      allow read: if request.auth != null;
      
      // Users can create their own posts
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own posts, or any authenticated user can update likes/comments arrays
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid ||
         (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy', 'comments']) &&
          request.resource.data.likes.size() >= 0 &&
          request.resource.data.comments.size() >= 0));
      
      // Users can delete their own posts, super admin can delete any post
      allow delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin');
    }

    // Alumni ID Requests rules
    match /idRequests/{requestId} {
      // Users can create their own request (using their UID as document ID)
      allow create: if request.auth != null && request.auth.uid == requestId;
      
      // Users can read their own request
      allow get: if request.auth != null && request.auth.uid == requestId;
      
      // TEMPORARY: Allow all authenticated users to list all requests (for testing)
      allow list: if request.auth != null;
      
      // Alumni association admin and super admin can read and update all requests
      allow get, update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['alumni_association_admin', 'super_admin'];
      
      // No one can delete requests
      allow delete: if false;
    }

    // Events rules - allow all authenticated users
    match /events/{eventId} {
      allow read, create, update, delete: if request.auth != null;
    }

    // Notifications rules - allow all authenticated users
    match /notifications/{notificationId} {
      allow read, create, update, delete: if request.auth != null;
    }

    // Comments rules (nested within posts)
    match /posts/{postId}/comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin');
      allow update: if false;
    }
  }
}
